---
# Install packages on bastion host
# Uses delegate_to: bastion pattern as per agnosticd-v2 PR #46

- name: Ensure facts are gathered for bastion
  delegate_to: bastion
  delegate_facts: true
  when: hostvars['bastion']['ansible_user_dir'] is not defined
  ansible.builtin.setup:
    gather_subset:
      - user  # We only really need user info, saves time

# 1. Install system packages (requires root)
- name: Install dnf packages on bastion
  delegate_to: bastion
  become: true
  when: bastion_packages | default([]) | length > 0
  ansible.builtin.dnf:
    name: "{{ bastion_packages }}"
    state: present

# 2. Bootstrap pip manually (User space)
- name: Bootstrap pip via ensurepip
  delegate_to: bastion
  become: false
  vars:
    bastion_home: "{{ hostvars['bastion']['ansible_user_dir'] }}"
  ansible.builtin.command: 
    cmd: python3 -m ensurepip --upgrade --user
    creates: "{{ bastion_home }}/.local/bin/pip3"

# 3. Install pip packages (User space)
- name: Install pip packages on bastion
  delegate_to: bastion
  when: bastion_pip_packages | default([]) | length > 0
  become: false
  vars:
    bastion_home: "{{ hostvars['bastion']['ansible_user_dir'] }}"
  ansible.builtin.pip:
    name: "{{ bastion_pip_packages }}"
    state: present
    executable: "{{ bastion_home }}/.local/bin/pip3"
    extra_args: --user
