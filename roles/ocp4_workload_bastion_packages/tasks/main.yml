---
# Install packages on bastion host
# Uses delegate_to: bastion pattern as per agnosticd-v2 PR #46

- name: Install dnf packages on bastion
  delegate_to: bastion
  when: bastion_packages | default([]) | length > 0
  become: true
  ansible.builtin.dnf:
    name: "{{ bastion_packages }}"
    state: present

- name: Check current user on bastion
  delegate_to: bastion
  ansible.builtin.command: whoami
  register: _bastion_user
  changed_when: false

- name: Show current user
  ansible.builtin.debug:
    msg: "Running as user: {{ _bastion_user.stdout }}"

- name: Install pip packages on bastion as connecting user
  delegate_to: bastion
  when: bastion_pip_packages | default([]) | length > 0
  environment:
    HOME: "/home/{{ bastion_ansible_user }}"
    USER: "{{ bastion_ansible_user }}"
  ansible.builtin.pip:
    name: "{{ item }}"
    state: present
    executable: pip3
    extra_args: --user
  loop: "{{ bastion_pip_packages }}"
